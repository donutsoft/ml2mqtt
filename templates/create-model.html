{% extends "base.html" %}
{% block content %}

<h2>Create New Model</h2>

<form method="POST" action="{{ url_for('createModel') }}">
    <div>
        <label for="model_name">Model Name</label>
        <input type="text" id="model_name" name="model_name" placeholder="e.g., AliceLocation" required>
        <small id="model_status" style="font-size: 0.9rem; display: block; margin-top: 0.25rem;"></small>
    </div>

    <div>
        <label for="default_value">Unavailable sensor fallback value</label>
        <input type="number" id="default_value" name="default_value" value="9999" step="any">
    </div>

    <div>
        <label for="mqtt_topic">MQTT Topic</label>
        <input type="text" id="mqtt_topic" name="mqtt_topic" placeholder="Auto-generated or edit manually">
    </div>

    <button type="submit" id="submit_btn">Create Model</button>
</form>

<script>
    const modelInput = document.getElementById('model_name');
    const subInput = document.getElementById('mqtt_topic');
    const status = document.getElementById('model_status');
    const submitBtn = document.getElementById('submit_btn');

    let debounceTimer;
    let slug;

    modelInput.addEventListener('input', () => {
        slug = modelInput.value
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g, '-')    // Replace spaces and symbols with hyphens
            .replace(/^-+|-+$/g, '');        // Trim leading/trailing hyphens

        if (!subInput.dataset.manual) {
            subInput.value = `ml2mqtt/${slug}`;
        }

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            if (slug.length < 3) {
                status.textContent = '';
                submitBtn.disabled = true;
                return;
            }
            fetch(`{{ url_for('checkModel') }}?name=${encodeURIComponent(slug)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.exists) {
                        status.textContent = "Model name already exists";
                        status.style.color = "#ff4d4d";
                        submitBtn.disabled = true;
                    } else {
                        status.textContent = "Model name is available";
                        status.style.color = "#00cc66";
                        submitBtn.disabled = false;
                    }
                })
                .catch(() => {
                    status.textContent = "Could not check model name";
                    status.style.color = "#ffa500";
                    submitBtn.disabled = true;
                });
        }, 400);

        // Mark inputs as "manual" if the user overrides the auto-generated values
        [subInput].forEach(input => {
            input.addEventListener('input', () => {
                input.dataset.manual = true;
            });
        });
    });

    // Initially disable the button until valid input is confirmed
    submitBtn.disabled = true;
</script>

{% endblock %}