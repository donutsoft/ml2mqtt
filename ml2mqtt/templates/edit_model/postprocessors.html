<h2>Postprocessors</h2>
<h4 style="color: #7e8c9c; margin-top: -0.25rem; margin-bottom: 1.5rem;">Model: {{ model.name }}</h4>
<p>Define any logic or formatting applied after the model predicts a result.</p>

<div class="settingsGroup">
  <h3>Postprocessors</h3>

  <div id="postprocessorList">
    {% for idx, postprocessor in enumerate(model.postprocessors) %}
      <div class="postprocessorRow" draggable="true"
           data-index="{{ idx }}"
           ondragstart="onDragStart(event)"
           ondragover="onDragOver(event)"
           ondragend="onDragEnd(event)"
           ondrop="onDrop(event)">
        <div>
          <strong>{{ postprocessor.id }} - {{ postprocessor.description }}</strong>
          {% if postprocessor.params %}
            <div class="subText">
              {% for key, value in postprocessor.params.items() %}
                {{ key }}: {{ value }}{% if not loop.last %}, {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="deleteColumn">
          <span class="deleteLink" onclick="removePostprocessor({{ idx }})">Delete</span>
        </div>
      </div>
    {% else %}
      <p style="color: #7e8c9c;">No postprocessors defined yet.</p>
    {% endfor %}
  </div>

  <div style="text-align: right; margin-top: 2rem;">
    <button class="btn primary" onclick="togglePostprocessorModal()">âž• Add Postprocessor</button>
  </div>
</div>

<!-- Modal -->
<div id="postprocessorModal" class="modalOverlay" style="display: none;">
  <div class="modalContent">
    <h3>Add Postprocessor</h3>

    <div class="formField">
      <label for="postType">Type</label>
      <select id="postType" class="styledSelect" onchange="updatePostParamUI()"></select>
      <div id="postDescription" class="fadeText"></div>
    </div>

    <div id="postParamsContainer"></div>

    <div class="formField buttonRow" style="justify-content: flex-end; margin-top: 1rem;">
      <button class="btn" onclick="togglePostprocessorModal()">Cancel</button>
      <button class="btn primary" onclick="submitPostprocessor()">Add</button>
    </div>
  </div>
</div>

<!-- Styles -->
<style>
  .deleteColumn {
    text-align: right;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    flex: 1;
  }

  .deleteLink {
    color: #ff4d4d;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
  }

  .deleteLink:hover {
    text-decoration: underline;
  }

  .formFieldRow {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
  }

  .modalOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modalContent {
    background: #1f2d3a;
    border: 1px solid #2c3e50;
    border-radius: 8px;
    padding: 2rem;
    width: 400px;
  }

  .postprocessorRow {
    border: 1px solid #2c3e50;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    background-color: #1a2735;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
  }

  .postprocessorRow.drag-over {
    background-color: #27384a;
    border: 2px dashed #4fa3f7;
  }

  .subText {
    color: #c0cbdc;
    font-size: 0.85rem;
    margin-top: 2px;
  }

  .buttonRow {
    display: flex;
    gap: 1rem;
  }

  /* Fade-in description */
  .fadeText {
    color: #c0cbdc;
    font-size: 0.9rem;
    margin-top: 0.5rem;
    opacity: 0;
    transition: opacity 0.4s ease;
    min-height: 1.2rem;
  }
  .fadeText.visible {
    opacity: 1;
  }
</style>

<!-- Scripts -->
<script>
  const availablePostprocessors = {{ availablePostprocessors|tojson }};
  const addPostprocessorUrl = "{{ url_for('model.addPostprocessor', modelName=model.name) }}";
  const deletePostprocessorUrl = "{{ url_for('model.deletePostprocessor', modelName=model.name) }}";
  const reorderPostprocessorsUrl = "{{ url_for('model.reorderPostprocessors', modelName=model.name) }}";

  function togglePostprocessorModal() {
    const modal = document.getElementById("postprocessorModal");
    modal.style.display = modal.style.display === "none" ? "flex" : "none";
  }

  function populatePostTypeDropdown() {
    const postTypeSelect = document.getElementById("postType");
    postTypeSelect.innerHTML = "";

    for (const processor of availablePostprocessors) {
      const option = document.createElement("option");
      option.value = processor.id;
      option.textContent = processor.id;
      postTypeSelect.appendChild(option);
    }

    updatePostParamUI();
  }

  function updatePostParamUI() {
    const type = document.getElementById("postType").value;
    const paramsContainer = document.getElementById("postParamsContainer");
    const descriptionContainer = document.getElementById("postDescription");

    paramsContainer.innerHTML = "";
    descriptionContainer.classList.remove("visible");

    const selectedProcessor = availablePostprocessors.find(p => p.id === type);
    if (!selectedProcessor) return;

    descriptionContainer.textContent = selectedProcessor.description || "";
    setTimeout(() => descriptionContainer.classList.add("visible"), 10);

    const properties = selectedProcessor.config_schema?.properties || {};

    if (Object.keys(properties).length === 0) {
      paramsContainer.style.display = "none";
      return;
    } else {
      paramsContainer.style.display = "block";
    }

    for (const [paramName, paramConfig] of Object.entries(properties)) {
      const fieldDiv = document.createElement("div");
      fieldDiv.className = "formField";

      const label = document.createElement("label");
      label.textContent = paramConfig.description || paramName;
      label.htmlFor = `postParam_${paramName}`;

      const input = document.createElement("input");
      input.type = paramConfig.type === "integer" ? "number" : "text";
      input.id = `postParam_${paramName}`;
      input.value = paramConfig.default || "";

      fieldDiv.appendChild(label);
      fieldDiv.appendChild(input);
      paramsContainer.appendChild(fieldDiv);
    }
  }

  function submitPostprocessor() {
    const type = document.getElementById("postType").value;
    const selectedProcessor = availablePostprocessors.find(p => p.id === type);
    if (!selectedProcessor) return;

    const params = {};
    const properties = selectedProcessor.config_schema?.properties || {};

    for (const paramName of Object.keys(properties)) {
      const input = document.getElementById(`postParam_${paramName}`);
      if (input) {
        const value = input.type === "number" ? parseInt(input.value) : input.value;
        params[paramName] = value;
      }
    }

    const payload = { type, params };

    fetch(addPostprocessorUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).then(res => {
      if (res.ok) window.location.reload();
      else showToast("Error adding postprocessor", true);
    });
  }

  function removePostprocessor(index) {
    fetch(deletePostprocessorUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ index })
    }).then(res => {
      if (res.ok) window.location.reload();
      else showToast("Error removing postprocessor", true);
    });
  }

  let dragStartIndex = null;

  function onDragStart(event) {
    dragStartIndex = Number(event.currentTarget.dataset.index);
    event.dataTransfer.effectAllowed = "move";
  }

  function onDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add("drag-over");
  }

  function onDragEnd(event) {
    document.querySelectorAll(".postprocessorRow").forEach(el => el.classList.remove("drag-over"));
  }

  function onDrop(event) {
    event.preventDefault();
    const dropIndex = Number(event.currentTarget.dataset.index);
    event.currentTarget.classList.remove("drag-over");

    if (dropIndex === dragStartIndex) return;

    fetch(reorderPostprocessorsUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fromIndex: dragStartIndex, toIndex: dropIndex })
    }).then(res => {
      if (res.ok) window.location.reload();
      else showToast("Failed to reorder postprocessors", true);
    });
  }

  document.addEventListener("DOMContentLoaded", populatePostTypeDropdown);
</script>
