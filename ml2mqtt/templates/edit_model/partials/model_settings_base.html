<div class="settings-group">
  <h3>Model Settings</h3>
  <form id="modelSettingsForm" class="form-group">
    <div class="form-group">
      <label for="modelType">Model Type</label>
      <select id="modelType" name="modelType" class="styledSelect" onchange="toggleModelParams()">
        <option value="RandomForest" {% if model.params.modelParameters.model_type == 'RandomForest' %}selected{% endif %}>Random Forest</option>
        <option value="KNN" {% if model.params.modelParameters.model_type == 'KNN' %}selected{% endif %}>K-Nearest Neighbors</option>
      </select>
    </div>

    <div id="modelParams">
      {% include 'edit_model/partials/model_settings/randomforest.html' %}
    </div>

    <div class="flex flex-between" style="margin-top: 2rem;">
      <button type="button" class="btn" id="showAdvancedBtn" onclick="toggleManualParams()">Manual Settings</button>
      <button type="button" class="btn btn-primary" onclick="autoTuneModel()">Auto-tune Parameters</button>
    </div>

    <div id="advancedParams" style="display: none;">
      <h4 style="margin-top: 2rem;">Manual Parameter Settings</h4>
      <div id="manualParams">
        {% include 'edit_model/partials/model_settings/randomforest.html' %}
      </div>
    </div>
  </form>
</div>

<div id="tuneToast" class="toast">
  <span id="toastMessage"></span><span id="toastDots"></span>
</div>

<script>
let toastInterval;

function toggleModelParams() {
  const modelType = document.getElementById("modelType").value;
  const modelParams = document.getElementById("modelParams");
  const manualParams = document.getElementById("manualParams");

  fetch(`/edit-model/{{ model.name }}/model-settings/${modelType}`)
    .then(res => res.text())
    .then(html => {
      modelParams.innerHTML = html;
      manualParams.innerHTML = html;
    });
}

function autoTuneModel() {
  showToast("Auto-tuning parameters", false, true);
  
  fetch(`/edit-model/{{ model.name }}/settings/autotune`, {
    method: "POST"
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showToast("Parameters optimized successfully", false);
      window.location.reload();
    } else {
      showToast("Failed to optimize parameters", true);
    }
  })
  .catch(err => {
    showToast("Error optimizing parameters", true);
  });
}

function showToast(message, isError = false, animated = false) {
  const toast = document.getElementById("tuneToast");
  const msg = document.getElementById("toastMessage");
  const dots = document.getElementById("toastDots");

  msg.textContent = message;
  dots.textContent = "";
  toast.classList.add("show");
  toast.style.backgroundColor = isError ? "#a94442" : "#222";

  if (animated) {
    let dotCount = 0;
    toastInterval = setInterval(() => {
      dotCount = (dotCount + 1) % 4;
      dots.textContent = ".".repeat(dotCount);
    }, 500);
  } else {
    clearInterval(toastInterval);
    dots.textContent = "";
    setTimeout(() => {
      toast.classList.remove("show");
    }, isError ? 5000 : 10000);
  }
}

function toggleManualParams() {
  const el = document.getElementById("advancedParams");
  const btn = document.getElementById("showAdvancedBtn");
  const isHidden = el.style.display === "none";
  showManualParams(isHidden);
}

function showManualParams(show) {
  const el = document.getElementById("advancedParams");
  const btn = document.getElementById("showAdvancedBtn");
  localStorage.setItem("showManualParams", show ? "true" : "false");

  el.style.display = show ? "block" : "none";
  if (btn) btn.textContent = show ? "Hide Manual Settings" : "Manual Settings";
}
</script>

<style>
.buttonRow {
  display: flex;
  gap: 1rem;
}
</style> 